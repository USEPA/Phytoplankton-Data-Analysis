---
title: "Data Organization - makes files for further analysis and checks data"
date: "updated September 27, 2016"
output:
  html_document:
    toc: true
    theme: united
---

```{r, echo = FALSE, message=FALSE, warning=FALSE, error=FALSE}
#**RUN
library(ggplot2)
library(plyr)
library(dplyr)
library(reshape2)
library(lubridate)
library(openxlsx)
setwd("~/repos/EPA TO57/analysis")  #Set this to where you will store your .Rmd files
```

This file load the big algae file and then creates the data sets used for subsequent analysis and has code for performing checks of the data file.  Statements starting with *with(* are for checking the data and are not necessary to run. 

You will need to re-run everything all code chunks with a #**RUN as the first line when the algae file is updated.  *You do not need to run this if the algae file is not changed - just go straight to the analysis files you would like to use*


```{r ReadData}
#**RUN
# Read data in from the current algae file (Set directory for your computer)
#alg <- read.xlsx("../data/Algae_20160804.xlsx", detectDates=TRUE)
#alg <- read.xlsx("../data/Algae_20160829.xlsx", detectDates=TRUE)
alg <- read.xlsx("../data/Algae_20160913.xlsx", detectDates=TRUE) 
dim(alg) #check dimensions
names(alg) #look at column names
```



```{r FixDate}
#**RUN
#Create a new column called date1 that R will recognize and manipulate as a date 
alg <- mutate(alg, date1=as.Date(paste(substring(date,1,4),"-", substring(date,5,6),"-", substring(date,7,8), sep="")))
```

#Subsetting the data

Data are initially subset by the following criteria:

1. Station names not starting with a 1 and containing no alpha characters (all numeric)
2. Samples that are *not* from "harmful algae bloom" (hab) samples ("hab==0")"

```{r SubsetData}
#station_list <- with(alg, unique(station))

#Make a list of the good stations (but these still have some hab samples)
good_stations <- c("20001", "20014", "20002", "20022", "20007", "20004", "20015", "20003", "20005", "20008", "20009", "21002", "20198", "20132", "20059", "21001", "20178", "21005", "21004", "20141", "20011", "20047", "20035", "20024", "22404", "20140", "20006", "20063", "20039", "21203", "20012", "20179", "20085", "21101", "21003", "22001", "23001", "20041", "21000", "20025", "20027", "20030", "20026", "20031", "20028", "20417", "20010", "20147", "20029", "22409", "20016", "20136", "20112", "20044", "20037", "20019", "21078", "21007", "20018")
length(good_stations)

#Make new columns for combinations of names of lake, station, date, and depth
alg2 <- mutate(filter(alg, station %in% good_stations), lake_station=paste(lake,station), 
                 lake_station_date=paste(lake,station,date), 
                 lake_station_date_depth=paste(lake,station,date,depth_ft))
```

```{r alg2Checks}
with(alg2, length(unique(lake_station))) #138 unique lake/station combinations
with(alg2, length(unique(lake_station_date))) #4169 different sampling occasions
with(alg2, length(unique(lake_station_date_depth))) # 11772 total samples b/c multiple depths for each sampling occasion, but not all locations have all 4 depths (0,5,10,20)
with(filter(alg2, hab==1), length(unique(lake_station_date))) #819 hab samples
```


```{r alg3Create_nohab}
#**RUN
#Exclude the hab samples and make new column
alg3 <- mutate(filter(alg2, hab==0), BV.um3.L=as.numeric(BV.um3.L))
```


```{r alg3Check}
#Check alg3 without the hab samples
with(alg3, length(unique(lake_station))) #131 unique lake/station combinations
with(alg3, length(unique(lake_station_date))) #3465 different non-hab locations -- not 4169-819=3350, so some sampling occasions have hab samples and regular samples
with(alg3, length(unique(lake_station_date_depth))) #10987
```


## Deal with duplicates for all taxa

The qual_replicate column has Q's and R's.  For this analysis, we removed all observations with "Q's",  and for field replicates we calculate (1) the average of the two samples and (2) the maximum of the two samples.  

*UPDATE NOTE: In earlier data files there were R to deal with, but with the new data set as of 9/13/16, there are no 'R's or Q's included.  Also look at the Wiki for how Matt created the 'R's and Q's to begin with.  If R's are only found with HAB samples, then this code will not be needed for this analysis, but I am leaving this code in for now because it doesn't hurt. If there aren't any R's, then the responses are all the same (result value = average result = max result), so it doesn't matter which one you are using.*


```{r InvestigateDuplicates1, eval=FALSE, include=FALSE}
#This code chunk is just to check things and does not need to be run

with(alg3, unique(qual_replicate)) #NA, "R", "Q" (As of 9/14 file, has only NA)
#alg3 %>% group_by(lake, station, date1, qual_replicate) %>% summarise(n())

dim(alg3)
with(alg3, sum(is.na(qual_replicate)==TRUE)) #all rows have NAs

###To look specifically at a date with field duplicates "R"
#select(filter(alg3, date=="20020710", depth_ft==0), date1, station, lake, taxa, depth_ft, cell_per_l, qual_replicate)

alg3 %>% group_by(lake, station, date1, qual_replicate) %>% dplyr::summarise(n())
```


```{r DealWith_QandR, include=FALSE}
#**RUN
alg3_noQ <- filter(alg3, is.na(qual_replicate)==TRUE|qual_replicate=="R")
#dim(alg3_noQ) 
#with(alg3_noQ, sum(is.na(qual_replicate)==FALSE)) 

#Just grab the ones with R's because I think the NA's are messing it up
alg3_Ronly <- filter(alg3_noQ, qual_replicate=="R")
alg3_maxR <- alg3_Ronly %>% 
              dplyr::group_by(lake_station, depth_ft, date1, taxa) %>%  
                 dplyr::summarise(cells_Rmax=max(cell_per_l), bv_Rmax=as.numeric(max(BV.um3.L)), 
                                    cells_Ravg=mean(cell_per_l), bv_Ravg=as.numeric(max(BV.um3.L)),
                                    toxin=toxin[1], sheet_id=sheet_id[1], Taxa.Type=Taxa.Type[1], 
                                    lake=lake[1], station=station[1])

alg3_NAonly <- dplyr::select(mutate(filter(alg3_noQ, is.na(qual_replicate)==TRUE), 
                      cells_Rmax=cell_per_l, bv_Rmax=as.numeric(BV.um3.L),
                      cells_Ravg=cell_per_l, bv_Ravg=as.numeric(BV.um3.L)),
                      lake_station, depth_ft, date1, taxa, cells_Rmax, bv_Rmax, 
                      cells_Ravg, bv_Ravg, toxin, sheet_id, Taxa.Type, lake, station)
                  
alg3_final1 <- bind_rows(alg3_NAonly, alg3_maxR)

#alg3_final1 contains new columns cells_Rmax = maximum of the two R samples for cell_per_l,
# cells_Ravg for average of the two R samples for cell_per_l, and then the analogous two
# for biovolume (bv_Rmax and bv_Ravg)

```


## Issues with depth

There are 12 different depths in the data, with 999 being the most problematic as it indicates depth is unknown.  These occur mainly in 1998 sampling.  They will not be included in the analysis until a depth is assigned to them, and are included in initial plots as "unknown".

```{r checkDepth, eval=FALSE, include=FALSE}
#Table of number of unique stations with measurements at the different depths
# So, 58 stations have unknown depths for at least some of the samples
with(alg3, tapply(lake_station, depth_ft, function(x) length(unique(x))))

#Look at where the depth of 1ft is coming from
with(alg3, lake_station[depth_ft==1]) #PRR 20001 is the lake with depth of 1

#Look at where the 999's are coming from
with(alg3, unique(lake_station[depth_ft==999]))
with(alg3, unique(year[depth_ft==999]))
```



```{r MakeNewDepthcolumn}
#**RUN
#Make new depth column depth_cat using breaks at 0, 5, 7, 14, 20, 21, 1000 to create 6 depth categories "0-3 ft", "5 ft", "7-10 ft", "14-17 ft", "20 ft", "unknown".  There is also one that lumps 0-5 together, but we haven't used this one

alg3_final <- mutate(alg3_final1, depth_cat=cut(as.numeric(depth_ft), breaks=c(0, 5, 7, 14, 20, 21, 1000), right=FALSE, labels=c("0-3 ft", "5 ft", "7-10 ft", "14-17 ft", "20 ft", "unknown")), depth_cat05=cut(as.numeric(depth_ft), breaks=c(0, 6, 11, 20, 21, 1000), right=FALSE, labels=c("0-5 ft", "7-10", "14-17 ft", "20 ft", "unknown")))
 #depth_cat05 has 0 and 5 ft depths lumped within the same category

save(alg3_final, file="DataForAnalysis_14Sept2016.Rdata") 
#save(alg3_final, file="DataForAnalysis_30Aug2016.Rdata") #accidentally overwrote the 30Aug2016 one
#load("DataForAnalysis_17Aug2016.Rdata")
```


```{r LookAtMissingness, eval=FALSE, include=FALSE}
#This code does not need to be run, but helps explore where missing values are
alg3_final2 <- dplyr::mutate(alg3_final, lake_station_date=paste(lake,station,date1))

with(alg3_final2, length(unique(lake_station))) #131 unique lake/station combinations
with(alg3_final2, length(unique(lake_station_date))) #3465 sampling occasions across all unique stations
with(alg3, length(unique(lake_station_date_depth))) #10987

#Only 0-3 ft
with(filter(alg3_final2, depth_cat=="0-3 ft"), length(unique(lake_station))) #124
with(filter(alg3_final2, depth_cat=="0-3 ft"), length(unique(lake_station_date))) #3163 different non-hab sampling occasions
with(alg3, length(unique(lake_station_date_depth)))

# Look at Blue-Green Algae
with(filter(alg3_final2, depth_cat=="0-3 ft", Taxa.Type=="Blue-Green Algae"), length(unique(lake_station_date))) #2945 (was 3542 or close to that in last data set)
with(filter(alg3_final2, depth_cat=="0-3 ft", Taxa.Type=="Blue-Green Algae"), length(unique(lake_station))) ##120
```



# Create response variables

Here, we create response variables for total cells/liter and biovolume for cyanobacteria, all taxa combined, and toxin producing species.  We also calculate the proportion of the total count or biovolume that is cyanobacteria.  

## Create Cyanobacteria (BG) total cell density and total biovolume for every unique sample

```{r createBGtotals, include=FALSE}
#**RUN
## Creates a dataframe with total cells and total biovolume for B-G Algae,
## and uses both the Ravg and Rmax for dealing with duplicates

#Method 1: This EXCLUDES all stations with NO Blue-Green Algae entries in the Taxa.Type column (not including possible real zeroes - the difference between the two methods should get smaller as the data set gets cleaner, assuming we expect at least a small amount of BG algae in each sample).
alg_bg <- filter(alg3_final, Taxa.Type=="Blue-Green Algae")

BGtotals_no0s_data <- alg_bg %>% 
                 group_by(lake, station, date1, depth_cat) %>%
                 dplyr::summarise(tot_cells_Rmax=sum(cells_Rmax),
                                  tot_bv_Rmax=sum(bv_Rmax),
                                  tot_cells_Ravg=sum(cells_Ravg), tot_bv_Ravg=sum(bv_Ravg))
dim(BGtotals_no0s_data) #10192 x 5
dim(filter(BGtotals_no0s_data, depth_cat=="0-3 ft")) #2945 x 8

save(BGtotals_no0s_data, file="BGtotals_no0s_data.Rdata")
View(BGtotals_no0s_data[1:100,])

#Method 2: This should include all the stations that have zero Blue-Green Algae
## THIS IS WHAT WE ARE USING FOR ANALYSIS ##
BGtotals_data <- alg3_final %>% 
                 group_by(lake, station, date1, depth_cat) %>%
                 dplyr::summarise(
                        tot_cells_Ravg=sum(na.omit(cells_Ravg[Taxa.Type=="Blue-Green Algae"])),
                        tot_bv_Ravg=sum(na.omit(bv_Ravg[Taxa.Type=="Blue-Green Algae"])),
                        tot_cells_Rmax=sum(na.omit(cells_Rmax[Taxa.Type=="Blue-Green Algae"])),
                        tot_bv_Rmax=sum(na.omit(bv_Rmax[Taxa.Type=="Blue-Green Algae"])),
                        sheet_id=sheet_id[1])

BGtotals_data <- mutate(BGtotals_data, month.f=as.factor(month(date1)), year.f=as.factor(year(date1)),
                         lake_station=paste(lake,station),
                         lake_station_date=paste(lake,station,date1), year=year(date1))

save(BGtotals_data, file="BGtotals_data.Rdata")
#View(filter(BGtotals_data, station=="20005")[1:100,])
```


```{r checkBGtotals, eval=FALSE, include=FALSE}
dim(BGtotals_data) #10980 x 12 (now have all the stations)

with(BGtotals_data, sum(tot_cells_Ravg==0)) #788 = 10980-10192 (so this matches above numbers)
with(filter(BGtotals_data, depth_cat=="0-3 ft"), length(unique(lake_station_date))) #3163 - total sampling occasions
with(filter(BGtotals_data, depth_cat=="0-3 ft"), sum(tot_cells_Rmax==0)) #218
with(BGtotals_data, sum(is.na(tot_cells_Ravg))) #0

with(BGtotals_data, sum(tot_bv_Ravg==0)) #909 -- some of these really should be NA's, but because doing the na.omit they come out to zero
with(filter(BGtotals_data, depth_cat=="0-3 ft"), sum(tot_bv_Rmax==0)) #242
#> test <- c(NA,NA,NA,NA)
#> sum(na.omit(test))
#[1] 0
with(BGtotals_data, sum(is.na(tot_bv_Ravg))) #0

### Need to see where the zeroes are coming from:
names(BGtotals_data)
with(filter(BGtotals_data, depth_cat=="0-3 ft"), unique(sheet_id[tot_cells_Rmax==0]))
with(filter(BGtotals_data, depth_cat=="0-3 ft"), sort(unique(year[tot_cells_Rmax==0])))
with(filter(BGtotals_data, depth_cat=="0-3 ft"), sort(unique(lake[tot_cells_Rmax==0])))
with(filter(BGtotals_data, depth_cat=="0-3 ft"), sort(unique(lake_station[tot_cells_Rmax==0])))
with(filter(BGtotals_data, depth_cat=="0-3 ft"), sort(unique(lake_station_date[tot_cells_Rmax==0])))

with(filter(BGtotals_data, depth_cat=="0-3 ft"), unique(sheet_id[tot_bv_Rmax==0]))
with(filter(BGtotals_data, depth_cat=="0-3 ft"), sort(unique(year[tot_bv_Rmax==0])))
with(filter(BGtotals_data, depth_cat=="0-3 ft"), sort(unique(lake[tot_bv_Rmax==0])))
with(filter(BGtotals_data, depth_cat=="0-3 ft"), sort(unique(lake_station[tot_bv_Rmax==0])))
with(filter(BGtotals_data, depth_cat=="0-3 ft"), sort(unique(lake_station_date[tot_bv_Rmax==0])))
```


## Create maximum summer BG total cell density and total biovolume for each year and each reservoir

```{r createSummerMaxBGtotals, eval=TRUE, include=FALSE}
#**RUN
#Create response variable that is the maximum from June through September for each year

#This is where the months included in summer are defined: 6,7,8,9
BGtotals_summer <- mutate(filter(BGtotals_data, month(date1) %in% c(6,7,8,9), depth_cat=="0-3 ft"), year=year(date1))
save(BGtotals_summer, file="BGtotals_summer.Rdata")

#Maximum over all stations in each summer
# This does not work for some lakes if try to go down to station level
BGtotals_maxsummer <- BGtotals_summer  %>% 
                 group_by(lake, year) %>%
                 dplyr::summarise(
                        maxtot_cells_Ravg=max(tot_cells_Ravg),
                        maxtot_bv_Ravg=max(tot_bv_Ravg),
                        maxtot_cells_Rmax=max(tot_cells_Rmax),
                        maxtot_bv_Rmax=max(tot_bv_Rmax),
                     datemax_cells_Ravg=max(date1[tot_cells_Ravg==max(tot_cells_Ravg)]),                        datemax_cells_Rmax=max(date1[tot_cells_Rmax==max(tot_cells_Rmax)]), 
                        datemax_bv_Ravg=max(date1[tot_bv_Ravg==max(tot_bv_Ravg)]),
                        datemax_bv_Rmax=max(date1[tot_bv_Rmax==max(tot_bv_Rmax)]),
                        num_samps_per_max=length(tot_cells_Rmax),
                        num_sampdates_per_max=length(unique(date1)))

save(BGtotals_maxsummer, file="BGtotals_maxsummer.Rdata")
```


## Create totals over ALL taxa

These totals make up the denominator for the relative (i.e. dominance) measures, but we also calculate them separately so they can be analyzed on their own.
```{r createTotalCellsALL, include=FALSE}
#**RUN
#NOTE:  NEED TO THINK MORE ABOUT THE DIFFERENCES BETWEEN THE TWO ALL TAXA SUMS -- WHY DOES THE NA.OMIT GIVE LESS O'S THAN NA'S THAT ARE PICKED UP IN FIRST ONE?  This should clear up as data are further cleaned

#Method1: Not omitting NA's
totals_alltaxa_data <- alg3_final %>% 
                 group_by(lake, station, date1, depth_cat) %>%
                 summarise(tot_cells_Ravg=sum(cells_Ravg), tot_bv_Ravg=sum(bv_Ravg),
                           tot_cells_Rmax=sum(cells_Rmax), tot_bv_Rmax=sum(bv_Rmax))
save(totals_alltaxa_data, file="totals_alltaxa_data.Rdata")
```

```{r checkTotals_alltaxa}
dim(totals_alltaxa_data) #10980 x 8
View(totals_alltaxa_data[1:100,])

#checks
with(totals_alltaxa_data, sum(tot_cells_Ravg==0)) #So none of the denominators for relative biovolume
                                                  # should be zero
with(totals_alltaxa_data, sum(is.na(tot_cells_Ravg))) #Saying there are no NA's??
with(totals_alltaxa_data, sum(na.exclude(tot_bv_Ravg)==0)) #0 --there are no zeroes after excluding the NAs
with(filter(totals_alltaxa_data, depth_cat=="0-3 ft"), sum(is.na(tot_bv_Ravg))) #298 NAs -- 242 for BG algae only

```

```{r totalcellsALL_noNAs, include=FALSE}
#**RUN
#Omits NA's in calcuations - if all are NA's, will give a 0
totals_alltaxaNONA_data <- alg3_final %>% 
                 group_by(lake, station, date1, depth_cat) %>%
                 summarise(tot_cells_Ravg=sum(na.omit(cells_Ravg)), tot_bv_Ravg=sum(na.omit(bv_Ravg)),
                           tot_cells_Rmax=sum(na.omit(cells_Rmax)), tot_bv_Rmax=sum(na.omit(bv_Rmax)))
totals_alltaxaNONA_data <- mutate(totals_alltaxaNONA_data, lake_station_date=paste(lake,station,date1),
                                  lake_station=paste(lake,station))

save(totals_alltaxaNONA_data, file="totals_alltaxaNONA_data.Rdata")
```

```{r checkTotalsalltaxsNONA}
dim(totals_alltaxaNONA_data) #10980 x 6
#if all values are NA's a 0 will be returned for the sum
#View(totals_alltaxaNONA_data[1:100,])

#checks
with(totals_alltaxaNONA_data, sum(tot_cells_Ravg==0)) #0 So none of the denominators for relative biovolume
with(totals_alltaxaNONA_data, sum(is.na(tot_cells_Ravg))) #0

with(totals_alltaxaNONA_data, sum(tot_bv_Ravg==0)) #119
with(filter(totals_alltaxaNONA_data, depth_cat=="0-3 ft"), sum(tot_bv_Ravg==0)) #24
with(filter(totals_alltaxaNONA_data, depth_cat=="0-3 ft"), unique(lake_station_date[tot_bv_Ravg==0]))
with(totals_alltaxaNONA_data, sum(is.na(tot_bv_Ravg))) #0 -- which matches the number of NAs in the relative biovolume
```


##Create totals over all taxa just for samples in the summer

```{r createSummerAllTaxaTotals }
#**RUN
#FOR SUMMER and 0-3 ft
# Make sure the summer definition is the same here as for BGtotals_maxsummer
ALLtotals_summer <- mutate(filter(totals_alltaxa_data, month(date1) %in% c(6,7,8,9), depth_cat=="0-3 ft"), year=year(date1))
ALLtotals_maxsummer <- ALLtotals_summer  %>% 
                 group_by(lake, year) %>%
                 dplyr::summarise(
                        maxtot_cells_Ravg=max(tot_cells_Ravg),
                        maxtot_bv_Ravg=max(tot_bv_Ravg),
                        maxtot_cells_Rmax=max(tot_cells_Rmax),
                        maxtot_bv_Rmax=max(tot_bv_Rmax),
                        datemax_cells_Ravg=max(date1[tot_cells_Ravg==max(tot_cells_Ravg)]),
                        datemax_cells_Rmax=max(date1[tot_cells_Rmax==max(tot_cells_Rmax)]), 
                        datemax_bv_Ravg=max(date1[tot_bv_Ravg==max(tot_bv_Ravg)]),
                        datemax_bv_Rmax=max(date1[tot_bv_Rmax==max(tot_bv_Rmax)]),
                        num_samps_per_max=length(tot_cells_Rmax),
                        num_sampdates_per_max=length(unique(date1)))

save(ALLtotals_maxsummer, file="ALLtotals_maxsummer.Rdata")

```


## Relative cells/L - "Blue-Green algae dominance""

Create the proportion of the total count that is BG algae

```{r createBGproportion, include=FALSE}
#**RUN
BGdom_data <- alg3_final %>% 
                 group_by(lake, station, date1, depth_cat) %>%
                 dplyr::summarise(
                  rel_cells_Ravg=(sum(na.omit(cells_Ravg[Taxa.Type=="Blue-Green Algae"]))/sum(cells_Ravg)),
                  rel_bv_Ravg=(sum(na.omit(bv_Ravg[Taxa.Type=="Blue-Green Algae"]))/sum(bv_Ravg)),
                  rel_cells_Rmax=(sum(na.omit(cells_Rmax[Taxa.Type=="Blue-Green Algae"]))/sum(cells_Rmax)),
                  rel_bv_Rmax=(sum(na.omit(bv_Rmax[Taxa.Type=="Blue-Green Algae"]))/sum(bv_Rmax)))

BGdom_data <- mutate(BGdom_data, month.f=as.factor(month(date1)))
save(BGdom_data, file="BGdom_data.Rdata")
```

```{r checkBGproportions, eval=FALSE, include=FALSE}
#checks
head(BGdom_data)
with(BGdom_data, sum(is.na(rel_cells_Ravg)==TRUE)) #0 - without the na.omit above there are over 9000 NA's for any station/date/depth that has an NA in Taxa.Type 

with(BGdom_data, sum(is.na(rel_bv_Ravg))) #1074 - still have the same number of na's for rel_bv
with(BGdom_data, sum(na.exclude(rel_bv_Ravg)==0)) #868

dim(BGdom_data)[1]-dim(BGtotals_data)[1]

#For tot_cells_Ravg there shouldn't be any zero's or NAs in numerator or denominator
#Check numerators and denominators together
#cell density
with(BGtotals_data, sum(tot_cells_Ravg==0)) #949 zeroes, down to 884 zeroes with 8/29 data
with(totals_alltaxa_data, sum(tot_cells_Ravg==0)) #0 
with(totals_alltaxa_data, sum(is.na(tot_cells_Ravg))) #0   
with(BGdom_data, sum(rel_cells_Ravg==0)) #949 zeroes - MATCHES what it should

#biovolume
with(BGtotals_data, sum(is.na(tot_bv_Ravg))) #0
with(BGtotals_data, sum(tot_bv_Ravg==0)) #1506
with(totals_alltaxa_data, sum(is.na(tot_bv_Ravg))) #1074         
with(totals_alltaxa_data, sum(na.exclude(tot_bv_Ravg)==0)) #0 
with(BGdom_data, sum(is.na(rel_bv_Ravg))) #1074
with(BGdom_data, sum(na.exclude(rel_bv_Ravg)==0)) #868
```


```{r createBGdominanceNONA, include=FALSE}
#**RUN
#Same calculations as above, but using na.omit.  When the dataset gets all filled in there should
# not be a difference between the two methods for the different response variables
BGdom_data_NONA <- alg3_final %>% 
                 group_by(lake, station, date1, depth_cat) %>%
                 dplyr::summarise(
                  rel_cells_Ravg=(sum(na.omit(cells_Ravg[Taxa.Type=="Blue-Green Algae"]))/sum(na.omit(cells_Ravg))),
                  rel_bv_Ravg=(sum(na.omit(bv_Ravg[Taxa.Type=="Blue-Green Algae"]))/sum(na.omit(bv_Ravg))),
                  rel_cells_Rmax=(sum(na.omit(cells_Rmax[Taxa.Type=="Blue-Green Algae"]))/sum(na.omit(cells_Rmax))),
                  rel_bv_Rmax=(sum(na.omit(bv_Rmax[Taxa.Type=="Blue-Green Algae"]))/sum(na.omit(bv_Rmax))))

BGdom_data_NONA <- mutate(BGdom_data, month.f=as.factor(month(date1)))
save(BGdom_data_NONA, file="BGdom_data_NONA.Rdata")
```


```{r checkBGdominanceNONA, include=FALSE}
#checks
head(BGdom_data_NONA)
with(BGdom_data_NONA, sum(is.na(rel_cells_Ravg))) #0 - without the na.omit above there are over 9000 NA's for any 
                                                   # station/date/depth that has an NA in Taxa.Type 
with(BGdom_data_NONA, sum(is.na(rel_bv_Ravg))) #1074 - still have the same number of na's for rel_bv  #874
with(BGdom_data_NONA, sum(na.exclude(rel_bv_Ravg)==0)) #868  #768

dim(BGdom_data)[1]-dim(BGtotals_data)[1]

#For tot_cells_Ravg there shouldn't be any zero's or NAs in numerator or denominator
#Check numerators and denominators together
#cell density
with(BGtotals_data, sum(tot_cells_Ravg==0)) #884 zeroes with 8/29 data
with(totals_alltaxa_data, sum(tot_cells_Ravg==0)) #0 
with(totals_alltaxa_data, sum(is.na(tot_cells_Ravg))) #0   
with(BGdom_data_NONA, sum(rel_cells_Ravg==0)) #884 zeroes - MATCHES what it should

#biovolume
with(BGtotals_data, sum(is.na(tot_bv_Ravg))) #0
with(BGtotals_data, sum(tot_bv_Ravg==0)) #1506
with(totals_alltaxa_data, sum(is.na(tot_bv_Ravg))) #1074         
with(totals_alltaxa_data, sum(na.exclude(tot_bv_Ravg)==0)) #0 
with(BGdom_data, sum(is.na(rel_bv_Ravg))) #1074
with(BGdom_data, sum(na.exclude(rel_bv_Ravg)==0)) #868
```


```{r createMaxSummerBGproportions}
#**RUN
#Maximum summer proportion of BG total celss and biovolume
BGdom_summer <- mutate(filter(BGdom_data_NONA, month(date1) %in% c(6,7,8,9), depth_cat=="0-3 ft"), year=year(date1))
BGdom_maxsummer <- BGdom_summer  %>% 
                 group_by(lake, year) %>%
                 dplyr::summarise(
                        maxrel_cells_Ravg=max(rel_cells_Ravg),
                        maxrel_bv_Ravg=max(rel_bv_Ravg),
                        maxrel_cells_Rmax=max(rel_cells_Rmax),
                        maxrel_bv_Rmax=max(rel_bv_Rmax),
                        datemax_cells_Ravg=max(date1[rel_cells_Ravg==max(rel_cells_Ravg)]),
                        datemax_cells_Rmax=max(date1[rel_cells_Rmax==max(rel_cells_Rmax)]), 
                        datemax_bv_Ravg=max(date1[rel_bv_Ravg==max(rel_bv_Ravg)]),
                        datemax_bv_Rmax=max(date1[rel_bv_Rmax==max(rel_bv_Rmax)]),
                        num_samps_per_max=length(rel_cells_Rmax),
                        num_sampdates_per_max=length(unique(date1)))

save(BGdom_maxsummer, file="BGdom_maxsummer.Rdata")
```



```{r DebugNAsInDom, eval=FALSE, include=FALSE}
## USED THIS TO JUST CHECK SUMMARISE() - do not need to run it
## #This code is used to understand where the NAs were coming from when calculating BG dominance

alg3_final2 <- mutate(alg3_final, lake_station_date=paste(lake,station,date1), lake_station_date_depth=paste(lake,station,date1,depth_ft))

lsdd_list <- with(alg3_final2, unique(lake_station_date_depth))
BGdom_cells <- numeric(length(lsdd_list))
  for (l in 1:length(lsdd_list)){
    BGdom_cells[l] <- with(alg3_final2, sum(cells_Ravg[lake_station_date_depth==lsdd_list[l] & Taxa.Type=="Blue-Green Algae"])/sum(cells_Ravg[lake_station_date_depth==lsdd_list[l]]))
  }
BGdom_dat1 <- data.frame(lsdd_list, BGdom_cells)  #how to get other columns I need?  just decompose the name
BGdom_dat2 <- arrange(mutate(BGdom_dat1, lake2=substring(lsdd_list,1,3), 
                                    station2=substring(lsdd_list,5,9), date2=as.Date(substring(lsdd_list,11,20)), depth2=substring(lsdd_list,22,24)), lake2, station2)

arrange(filter(BGdom_dat2, lake2=="EFR", station2=="20001", depth2==0), date2)[1:10,]
arrange(filter(totals_alltaxa_data, lake=="EFR", station=="20001", depth_cat=="0-3 ft"), date1)[1:10,]
arrange(filter(BGtotals_data, lake=="EFR", station=="20001", depth_cat=="0-3 ft"), date1)[1:10,]
  #I checked that total counts match by the summarise method and the loop method above
View(BGtotals_data$tot_cells_Ravg[1:10])

with(alg3_final2, sum(cells_Ravg[lake_station_date_depth=="EFR 20001 1993-07-14 0" & Taxa.Type=="Blue-Green Algae"])) #why is this NA?
with(alg3_final2, Taxa.Type[lake_station_date_depth=="EFR 20001 1993-07-14 0"])
with(alg3_final2, cells_Ravg[lake_station_date_depth=="EFR 20001 1993-07-14 0"])
with(alg3_final2, cells_Ravg[lake_station_date_depth=="EFR 20001 1993-07-14 0" & Taxa.Type=="Blue-Green Algae"])
with(alg3_final2, sum(na.omit(cells_Ravg[lake_station_date_depth=="EFR 20001 1993-07-14 0" & Taxa.Type=="Blue-Green Algae"]))) #works!

with(alg3_final2, sum(cells_Ravg[lake_station_date_depth=="EFR 20001 1993-06-16 0" & Taxa.Type=="Blue-Green Algae"]))
with(alg3_final2, sum(cells_Ravg[lake_station_date_depth=="EFR 20001 1993-07-14 0"]))
     /sum(cells_Ravg[lake_station_date_depth==lsdd_list[l]]))

##Now check a few zeroes.  We don't have any zeroes when we subset the data to Blue-Green Algae, but I think I'm doing that wrong
# because it's just not including the stations that have any Blue-Green Algae 

```


# Toxin producing species

```{r createToxinTotals_noNAs, include=FALSE}
#**RUN
toxin_totals <- alg3_final %>% 
                 group_by(lake, station, date1, depth_cat) %>%
                 summarise(tot_cells_Ravg=sum(na.omit(cells_Ravg[toxin==TRUE])),
                           tot_bv_Ravg=sum(na.omit(bv_Ravg[toxin==TRUE])),
                           tot_cells_Rmax=sum(na.omit(cells_Rmax[toxin==TRUE])),
                           tot_bv_Rmax=sum(na.omit(bv_Rmax[toxin==TRUE])))
save(toxin_totals, file="toxin_totals.Rdata")
```


```{r createToxinSummerMax, include=FALSE}
#**RUN
toxin_totals_summer <- mutate(filter(toxin_totals, month(date1) %in% c(6,7,8,9), depth_cat=="0-3 ft"), year=year(date1))
toxin_totals_maxsummer <- toxin_totals_summer  %>% 
                 group_by(lake, year) %>%
                 dplyr::summarise(
                        maxtot_cells_Ravg=max(tot_cells_Ravg),
                        maxtot_bv_Ravg=max(tot_bv_Ravg),
                        maxtot_cells_Rmax=max(tot_cells_Rmax),
                        maxtot_bv_Rmax=max(tot_bv_Rmax),
                        datemax_cells_Ravg=max(date1[tot_cells_Ravg==max(tot_cells_Ravg)]),
                        datemax_cells_Rmax=max(date1[tot_cells_Rmax==max(tot_cells_Rmax)]), 
                        datemax_bv_Ravg=max(date1[tot_bv_Ravg==max(tot_bv_Ravg)]),
                        datemax_bv_Rmax=max(date1[tot_bv_Rmax==max(tot_bv_Rmax)]),
                        num_samps_per_max=length(tot_cells_Rmax),
                        num_sampdates_per_max=length(unique(date1)))


   #Issue --- when there are only 0's for a particular year-lake combination and there are multiple occasions with zeroes - then there are multiple dates for the max, which messes with this.  I'm just choosing the maximum date when this is the case. 

save(toxin_totals_maxsummer, file="toxin_totals_maxsummer.Rdata")
```


## Number of distinct taxa detected per lake, station, date, depth

An assumption behind the total counts is that the effort going into the counts is constant over time.  Ideally, we would have a list of possible taxa and record whether each showed up or not -- so that we know how many were "looked" for and can model presence/absence as well as counts.  So, we need to assume that any taxa recorded at one time would have been recorded if it showed up in another time.  Sounds like this is not a bad assumption, but because methods, labs, etc. have changed, it should be thought about.  By looking at the number of taxa, we don't know that it reflects data collection procedures or just the actual number of taxa available, but I think it is at least worth looking at -- if it remains fairly constant over time then this can possibly help with your justifcation of effort.

This gives us the number of taxa going into each total, which we should keep track of as we move to creating totals.  This is really just giving the number of observations at each lake x station x date x depth combination, which should be the number of "taxa" going into the total counts (it is at least the number of different counts going into the total).
```{r BG_numtaxa, include=FALSE}
#**RUN
# Note this is all taxa in sample and not split up by BG, etc., though could easily be 
# extended to do that.  It just give the number of rows in the data set associated with
# each lake-station-date-depth combination, which should be fine when there are no field
# duplicates (but think through this more before putting too much weight on it)
num_taxa_data <- alg3_final %>% 
                 group_by(lake, station, date1, depth_cat) %>% 
                 dplyr::summarise(num_taxa=n())
dim(num_taxa_data) #10980 x 5

save(num_taxa_data, file="num_taxa_data.Rdata")
#BGnum_genus_data <- alg_bg %>% group_by(lake, station, date1, depth_cat) %>% dplyr::summarise(num_taxa=n())
#dim(BGnum_taxa_data) #10632 x 5


BGnum_taxa_data <- alg3_final %>% 
                 group_by(lake, station, date1, depth_cat) %>% 
                 dplyr::summarise(num_taxa=length(cells_Rmax[Taxa.Type=="Blue-Green Algae"]))
dim(BGnum_taxa_data) #10980 x 5
#Could also filter by BG first, but this then gets rid of all samples with no blue green algae
save(BGnum_taxa_data, file="BGnum_taxa_data.Rdata")


TOXINnum_taxa_data <- alg3_final %>% 
                 group_by(lake, station, date1, depth_cat) %>% 
                 dplyr::summarise(num_taxa=length(cells_Rmax[toxin==TRUE]))
dim(TOXINnum_taxa_data) #10980 x 5

save(TOXINnum_taxa_data, file="TOXINnum_taxa_data.Rdata")

```







#Additional things that are not currently necessary ***************************

## Filtering directly to Cyanobacteria - Blue-Green Algae

This subsets the data to only include samples of Blue-Green Algae and ignores everything else.  This would be fine for BG summaries if the Taxa.Type Column were complete, but better use code that creates BGtotals

```{r, eval=FALSE, include=FALSE}
#To select cyanobacteria, we select for Taxa.Type = "Blue-Green Algae".  NOTE** As of Sept. 14th, this does not include all cyanobacteria because of matching of "taxa" to "Accepted.Name" for new data.

#with(alg3, unique(Taxa.Type))
alg_bg <- filter(alg3_final, Taxa.Type=="Blue-Green Algae")
#save(alg_bg, file="BGdata_20160913.Rdata")
#save(alg_bg, file="BGdata_20160830.Rdata")
#dim(alg_bg) #65070 x 13 -- with new data set went up to 72310
```



## Calculations for number of samples per station/reservoir/date

This code is probably not needed now, as I think it can be done as part of above code.
I am leaving it in here for now, just in case this is of interest later.  


## Number of sampling occasions for each station in each reservoir

```{r, eval=FALSE, include=FALSE}
#Look at stations
with(alg, length(unique(station))) #138 before subsetting
with(alg3, length(unique(station))) #55 after subsetting

# Calculate the number of unique dates per station/lake to get total number of sampling occasions
# for each station/lake.  Different depths are sampled on same date, so we are not overcounting
lake_station_list <- with(alg3, unique(lake_station))
samples_per_station <- numeric(length(lake_station_list))
  for (i in 1:length(lake_station_list)){
    samples_per_station[i] <- with(alg3, length(unique(date[lake_station==lake_station_list[i]])))
  }
num_samples1 <- data.frame(lake_station_list, samples_per_station)
num_samples <- arrange(mutate(num_samples1, lake1=substring(lake_station_list,1,3), 
                                    station2=substring(lake_station_list,5,9)), lake1, station2)
```

```{r SamplingByYearsByStation, include=FALSE}
#FIND BETTER way to do this, but okay for now
#This does account for depth (doesn't over count) because we are counting unique dates to get the numbers

#Look at list of years with data
year_list <- sort(with(alg3, unique(year)))
lake_station_list <- with(alg3, unique(lake_station))
#Year data:  First year of sampling in 1987.  There is no data for 1989-1991 or 1994 or 1997.  There is one year recorded as "1405" and need to find out what it should be.

samples_per_stationyear <- matrix(nrow=length(lake_station_list), ncol=length(year_list))
for (i in 1:length(lake_station_list)){
    for (j in 1:length(year_list)) {
      samples_per_stationyear[i,j] <- with(alg3, length(unique(date[lake_station==lake_station_list[i] & year==year_list[j]])))
    }
  }
d1 <- data.frame(samples_per_stationyear)

num_samps_year1 <- mutate(d1, lake_station=lake_station_list)
num_samps_year <- arrange(mutate(num_samps_year1, lake1=substring(lake_station,1,3), 
                                    station2=substring(lake_station,5,9)), lake1, station2)
print(num_samps_year)

print(num_samps_year[,23:26])

names(num_samps_year)

save(num_samps_year, file="num_samps_year.Rdata")
 #seems like there are too many samples in 2013 -- maybe some of the habs are still there?
```

```{r JuneSeptSamples, echo=FALSE}
## Should check MayJune Samples PER YEAR, rather than just anywhere b/c won't help if they are mainly coming from only
# a few years
alg_summer <- filter(alg3, month(date1) %in% c(6,7,8,9))

year_list <- sort(with(alg3, unique(year)))
lake_station_list <- with(alg3, unique(lake_station))

summer_per_stationyear <- matrix(nrow=length(lake_station_list), ncol=length(year_list))
for (i in 1:length(lake_station_list)){
    for (j in 1:length(year_list)) {
      summer_per_stationyear[i,j] <- with(alg_summer, length(unique(date[lake_station==lake_station_list[i] & year==year_list[j]])))
    }
  }
d1_summer <- data.frame(summer_per_stationyear)
colnames(d1_summer) <- year_list
summer_samps_year1 <- mutate(d1_summer, lake_station=lake_station_list)
summer_samps_year <- arrange(mutate(summer_samps_year1, lake1=substring(lake_station,1,3), 
                                    station2=substring(lake_station,5,9)), lake1, station2)
print(summer_samps_year)

#Calculate number of years 
summer_per_station <- apply(summer_samps_year, 1, function(x) sum(x>0))
 #We do have quite a few stations with 10 or more years with observations in May or June

#save(summer_samps_year, file="summer_samps_year.Rdata")

#ggplot(summer_samples_summer) + geom_bar(stat="identity", aes(y=samples_per_station, x=lake_station_list, fill=lake1)) + ylab("Number sampling occasions - June-Sept") + xlab("station")
```




# Plots used to originally understand the data

```{r SamplingDatesPerStation, echo=FALSE}
#with(num_samples, barplot(samples_per_station))

ggplot(num_samples) + geom_bar(stat="identity", aes(y=samples_per_station, x=lake_station_list, fill=lake1)) + ylab("Number of sample dates") + xlab("station")

#Could using stat_  to plot just the maximum number per reservoir.
# TO DO

```


```{r}
lake_list <- unique(BGnum_taxa_data$lake)
for (l in lake_list) {
  plot.dat <- filter(BGnum_taxa_data, lake==l)
  d <- ggplot(plot.dat) + 
        geom_point(aes(x=date1, y=num_taxa, colour=station)) +
        geom_line(aes(x=date1, y=num_taxa, colour=station)) + 
        facet_wrap(~depth_cat, nrow=6, ncol=1) + 
        ggtitle(l) +
        scale_x_date(date_minor_breaks = "1 year") +
        ylab("Number of Blue-Green taxa") +
        xlab("Sampling date")
      print(d)
}
```

```{r BGtotalcellsplot1, echo=FALSE}
lake_list <- unique(num_taxa_data$lake)
for (l in 1:lake_list) {
  plot.dat <- filter(BGtotals_data, lake==l)
  d <- ggplot(plot.dat) + 
        geom_point(aes(x=date1, y=tot_cells_Ravg, colour=station)) +
        geom_line(aes(x=date1, y=tot_cells_Ravg, colour=station)) + 
        facet_wrap(~depth_cat, nrow=6, ncol=1) + 
        ggtitle(paste(l, "Blue-Green Algae")) +
        scale_x_date(date_minor_breaks = "1 year") +
        ylab("Total cells/L")
      print(d)
}
```

```{r BGtotalcellsplot1, echo=FALSE}
lake_list <- unique(num_taxa_data$lake)
for (l in 1:lake_list) {
  plot.dat <- filter(BGtotals_data, lake==l)
  d <- ggplot(plot.dat) + 
        geom_point(aes(x=date1, y=log(tot_cells_Ravg), colour=station)) +
        geom_line(aes(x=date1, y=log(tot_cells_Ravg), colour=station)) + 
        facet_wrap(~depth_cat, nrow=6, ncol=1) + 
        ggtitle(paste(l, "Blue-Green Algae")) +
        scale_x_date(date_minor_breaks = "1 year") +
        ylab("Total cells/L")
      print(d)
}
```

## Check the above calculation
```{r BGtotalcellsplot1, echo=FALSE, include=FALSE}
lake_list <- c("EFR", "CHL", "RRR", "BHR")
for (l in lake_list) {
  plot.dat <- filter(BGtotals_data, lake==l, depth_cat=="0-3 ft")
  plot.dat2 <- filter(BGtotals_summer, lake==l)
  plot.dat3 <- filter(BGtotals_maxsummer, lake==l)
  #View(plot.dat2)
  
  d <- ggplot() + 
        geom_point(data=plot.dat, aes(x=date1, y=log(tot_cells_Ravg)), col=1, shape=1, size=2) +
        #geom_line(data=plot.dat, aes(x=date1, y=log(tot_cells_Ravg))) + 
        geom_point(data=plot.dat2, aes(x=date1, y=log(tot_cells_Ravg)), col=2, shape=16,
                   size=1) +
        #geom_line(data=plot.dat2, aes(x=date1, y=log(tot_cells_Ravg))) + 
        geom_point(data=plot.dat3, aes(x=datemax_cells_Ravg, y=log(maxtot_cells_Ravg)),
                    col="magenta", shape=10) +
        geom_line(data=plot.dat3, aes(x=datemax_cells_Ravg, y=log(maxtot_cells_Ravg)),
                    col=gray(0.3)) + 
        ggtitle(paste(l, "Blue-Green Algae - All good stations")) +
        scale_x_date(date_minor_breaks = "1 year") +
        ylab("Total cells/L") + xlab("Sampling date")
      print(d)
}
```


```{r BGtotalbvplot1, echo=FALSE}
lake_list <- unique(num_taxa_data$lake)
for (l in lake_list[1:3]) {
  plot.dat <- filter(BGtotals_data, lake==l)
  d <- ggplot(plot.dat) + 
        geom_point(aes(x=date1, y=tot_bv_Ravg, colour=station)) +
        geom_line(aes(x=date1, y=tot_bv_Ravg, colour=station)) + 
        facet_wrap(~depth_cat, nrow=6, ncol=1) + 
        ggtitle(paste(l, "Blue-Green Algae")) +
        scale_x_date(date_minor_breaks = "1 year") +
        ylab(expression(paste("Total biovolume", " ", mu~m^{3}/L)))
      print(d)
    }
```

```{r BGdom_bvplot_log, echo=FALSE}
### NOT WORKING YET -- issues with NAs before log transformation


lake_list <- unique(num_taxa_data$lake)
for (l in lake_list[1:3]) {
  plot.dat <- mutate(na.omit(filter(BGtotals_data, lake==l)), ind_zero=ifelse(tot_bv_Ravg==0, 1, 0),
                       log_tot_bv_Ravg=log(tot_bv_Ravg+1))
  d <- ggplot(plot.dat, aes(x=date1, y=log_tot_bv_Ravg)) + 
        geom_point(aes(colour=station, shape=factor(ind_zero)), size=2) +
        geom_line(aes(colour=station)) + 
        facet_wrap(~depth_cat, nrow=6, ncol=1) + 
        ggtitle(paste(l, "Blue-Green Algae")) +
        scale_x_date(date_minor_breaks = "1 year") +
        ylab(expression(paste(log("Total biovolume", " ", mu~m^{3}/L)))) +
        ylim(c(-1,30))
      print(d)
    }
```

```{r BGdom_cellplot_logit, echo=FALSE}
logit_fun <- function(x) {log(x/(1-x))}

summary(BGdom_data$rel_cells_Ravg)
min(BGdom_data$rel_cells_Ravg[BGdom_data$rel_cells_Ravg>0]) #smallest non-zero value is 0.000802
#So using something smaller than 0.000802 for the zeroes
logit_fun2 <- function(x) {log((x/(1-x))+0.0005)}

BGdom_data0 <- mutate(BGdom_data, ind_zero=ifelse(rel_cells_Ravg==0, 1, 0))
lake_list <- unique(BGdom_data$lake)
for (l in lake_list[1:3]) {
  plot.dat <- filter(BGdom_data0, lake==l)
  d <- ggplot(plot.dat, aes(x=date1, y=logit_fun2(rel_cells_Ravg))) + 
        geom_point(aes(colour=station, shape=factor(ind_zero)), size=1.5) +
        geom_line(aes(colour=station)) + 
        facet_wrap(~depth_cat, nrow=6, ncol=1) + 
        ggtitle(paste(l, "Logit Proportion Blue-Green Algae")) +
        scale_x_date(date_minor_breaks = "1 year") +
        ylab("Logit(Proportion BG (cells/L))")
      print(d)
}
```




```{r BGdom_bvplot, echo=FALSE}
lake_list <- unique(BGdom_data$lake)
for (l in lake_list[1:3]) {
  plot.dat <- filter(BGdom_data, lake==l)
  d <- ggplot(plot.dat) + 
        geom_point(aes(x=date1, y=rel_bv_Ravg, colour=station)) +
        geom_line(aes(x=date1, y=rel_bv_Ravg, colour=station)) + 
        facet_wrap(~depth_cat, nrow=6, ncol=1) + 
        ggtitle(paste(l, "Proportion Blue-Green Algae")) +
        scale_x_date(date_minor_breaks = "1 year") +
        ylab("Proportion BG (biovolume)")
      print(d)
}
```


```{r BGdom_bvplot_logit, echo=FALSE}
logit_fun <- function(x) {log(x/(1-x))}

summary(BGdom_data$rel_bv_Ravg)
min(na.exclude(BGdom_data$rel_bv_Ravg[BGdom_data$rel_bv_Ravg>0])) #smallest non-zero value is 0.00000621
#So using something smaller than above minimum for the zeroes
logit_fun2 <- function(x) {log((x/(1-x))+0.000005)}

BGdom_data0 <- mutate(BGdom_data, ind_zero_bv=ifelse(rel_bv_Ravg==0, 1, 0))
lake_list <- unique(BGdom_data$lake)
for (l in lake_list[1:3]) {
  plot.dat <- filter(BGdom_data0, lake==l)
  d <- ggplot(plot.dat, aes(x=date1, y=logit_fun2(rel_bv_Ravg))) + 
        geom_point(aes(colour=station, shape=factor(ind_zero_bv)), size=1.5) +
        geom_line(aes(colour=station)) + 
        facet_wrap(~depth_cat, nrow=6, ncol=1) + 
        ggtitle(paste(l, "Logit Proportion Blue-Green Algae")) +
        scale_x_date(date_minor_breaks = "1 year") +
        ylab("Logit(Proportion BG (biovolume))")
      print(d)
}
```

```{r BGdom_cellplot, echo=FALSE}
lake_list <- unique(BGdom_data$lake)
for (l in lake_list[1:3]) {
  plot.dat <- filter(BGdom_data, lake==l)
  d <- ggplot(plot.dat) + 
        geom_point(aes(x=date1, y=rel_cells_Ravg, colour=station)) +
        geom_line(aes(x=date1, y=rel_cells_Ravg, colour=station)) + 
        facet_wrap(~depth_cat, nrow=6, ncol=1) + 
        ggtitle(paste(l, "Proportion Blue-Green Algae")) +
        scale_x_date(date_minor_breaks = "1 year") +
        ylab("Proportion BG (cells/L)")
      print(d)
}
```

